Highly unreadable version with bit manipulations, but it is very very fast. 
